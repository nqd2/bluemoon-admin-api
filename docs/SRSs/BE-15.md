### PHẦN 1: TÀI LIỆU KỸ THUẬT (SRS) CHO TICKET [BE-15]

#### **Ticket: [BE-15] Dashboard Statistics (Thống kê Dashboard)**

**1. Thông tin chung**

* **Assignee:** Backend Dev
* **Branch Name:** `feature/BE-15-dashboard-stats`
* **Estimated Time:** 2h

**2. Mô tả (Description)**
API cung cấp các số liệu tổng quan cho màn hình chính (Dashboard) của Admin.

**3. Yêu cầu kỹ thuật (Technical Specs)**

*   **Endpoint:** `GET /api/stats/dashboard`
*   **Authentication:** Yêu cầu `Bearer Token`.
*   **Logic:** Thực hiện các query count/aggregate song song (Promise.all) để tối ưu hiệu năng.
    1.  `totalResidents`: `db.residents.countDocuments({ status: { $ne: 'Đã chuyển đi' } })` (Chỉ đếm người đang ở).
    2.  `totalApartments`: `db.apartments.countDocuments({})`.
    3.  `totalRevenue`: Aggregate `Transactions`, sum `totalAmount`.
    4.  `monthlyRevenue`: Aggregate `Transactions`, match `date` trong tháng hiện tại, sum `totalAmount`.

**4. Response Structure**

```json
{
  "success": true,
  "data": {
    "totalResidents": 150,
    "totalApartments": 45,
    "totalRevenue": 150000000, // Tổng doanh thu từ trước đến nay
    "currentMonthRevenue": 5000000, // Doanh thu tháng này
    "recentTransactions": [ // 5 giao dịch gần nhất
      {
        "apartment": "P101",
        "fee": "Phí dịch vụ",
        "amount": 200000,
        "date": "..."
      }
    ],
    "apartmentStats": { // Thêm từ BE-17
      "total": 45,
      "status": [
        { "status": "Occupied", "count": 40 },
        { "status": "Vacant", "count": 5 }
      ],
      "byBuilding": [
        { "building": "Tòa A", "count": 20 },
        { "building": "Tòa B", "count": 25 }
      ]
    }
  }
}
```

**5. Acceptance Criteria**

* [x] **Performance:** Sử dụng `Promise.all` để chạy các query đồng thời, giảm thời gian chờ.
* [x] **Accuracy:**
    *   Số dân chỉ đếm người có `status` khác 'Đã chuyển đi' (hoặc `residencyStatus` là 'Thường trú' hoặc 'Tạm trú').
    *   Doanh thu tháng phải tính đúng range ngày (từ ngày 1 đến cuối tháng hiện tại).
* [x] **Recent Transactions:** Trả về thêm 5 giao dịch mới nhất (sắp xếp theo `date` giảm dần) để hiển thị widget "Hoạt động gần đây". Mỗi transaction được populate thông tin apartment và fee.
* [x] **Apartment Stats:** (Từ BE-17) Trả về thống kê căn hộ theo trạng thái (Occupied/Vacant) và phân bố theo tòa nhà.
