### PHẦN 1: TÀI LIỆU KỸ THUẬT (SRS) CHO TICKET [BE-16]

#### **Ticket: [BE-16] Registration & Registration Codes**

**1. Thông tin chung**

- **Assignee:** Nguyễn Quý Đức (Fullstack Lead)
- **Branch Name:** `feature/BE-16-registration`
- **Estimated Time:** 4h

**2. Mô tả (Description)**
Xây dựng tính năng đăng ký tài khoản mới thông qua mã đăng ký (Registration Code). Chỉ có Admin mới có thể tạo mã đăng ký. Mã đăng ký xác định vai trò (role) của tài khoản mới và có giới hạn số lần sử dụng cũng như thời gian hết hạn.
Ngoài ra, viết script tạo tài khoản Root Admin để khởi tạo hệ thống.

**3. Yêu cầu kỹ thuật (Technical Specs)**

**3.1. Database Models**

- **RegistrationCode Schema:**

  - `code`: String, required, unique, index.
  - `type`: String, enum ['admin', 'leader', 'accountant'], required. (Đây là role sẽ gán cho user).
  - `usageLimit`: Number, default 1. (Số lần mã có thể được sử dụng).
  - `usageCount`: Number, default 0. (Số lần đã sử dụng).
  - `expiresAt`: Date, required. (Thời gian hết hạn).
  - `createdBy`: ObjectId (ref User), required.
  - `timestamps`: true.
  - Method `isValid()`: Kiểm tra mã còn hợp lệ (chưa hết hạn và chưa vượt quá usageLimit).

- **User Schema Update:**
  - Thay đổi `email` thành `username` (String, unique, min 6 chars).
  - `role`: Enum ['admin', 'leader', 'accountant'].

**3.2. API Endpoints**

- **Create Registration Code (Admin Only):**

  - `POST /api/registration-codes`
  - Payload: `{ type: 'admin', usageLimit: 5, expiresIntermsOfHours: 24 }`
  - Response: `{ success: true, data: { code: 'ABC123...', type: 'admin', ... } }`

- **List Registration Codes (Admin Only):**

  - `GET /api/registration-codes`
  - Response: List of codes with usage stats.

- **Revoke/Delete Registration Code (Admin Only):**

  - `DELETE /api/registration-codes/:id`

- **Register New User:**
  - `POST /api/auth/register`
  - Payload: `{ username: 'user123', password: 'password123', code: 'ABC123...' }`
  - Logic:
    1.  Validate `username`, `password` (min 6 chars).
    2.  Check if username already exists -> Error 400.
    3.  Find `RegistrationCode` by `code`.
    4.  Check if code exists -> Error 400 if not found.
    5.  Check if code is valid using `isValid()` method (checks `expiresAt > now` and `usageCount < usageLimit`) -> Error 400 if invalid.
    6.  Create User with `role` = `code.type`.
    7.  Increment `code.usageCount`.
    8.  Response: Success message (user can then login).

**3.3. Scripts**

- `scripts/create-root-admin.ts`:
  - Script TypeScript để tạo tài khoản root admin.
  - Tự động chạy hoặc chạy thủ công.
  - Kiểm tra xem có user nào có role `admin` chưa.
  - Nếu chưa, tạo một user admin mặc định:
    - Username: từ biến môi trường `ROOT_ADMIN_USERNAME` (default: 'rootadmin').
    - Password: từ biến môi trường `ROOT_ADMIN_PASSWORD` (bắt buộc).
    - Role: 'admin'.

**4. Acceptance Criteria (Tiêu chí chấp nhận)**

- [ ] **Registration Code Management:**
  - Admin có thể tạo mã với role, giới hạn sử dụng, và hạn dùng xác định.
  - Admin xem được danh sách mã.
  - Mã quá hạn hoặc hết lượt dùng không thể sử dụng để đăng ký.
- [ ] **User Registration:**
  - User không thể đăng ký nếu không có mã hợp lệ.
  - User đăng ký thành công sẽ có role tương ứng với mã.
  - Mã đăng ký được cập nhật số lần sử dụng sau khi đăng ký thành công.
  - Validate username/password min 6 ký tự.
- [ ] **Root Admin Script:**
  - Script chạy thành công, tạo được user admin đầu tiên vào DB.
  - Script không tạo trùng nếu admin đã tồn tại.
- [ ] **Security:**
  - API tạo mã phải được bảo vệ (chỉ Admin).
  - API đăng ký là public nhưng được bảo vệ bởi logic mã code.
